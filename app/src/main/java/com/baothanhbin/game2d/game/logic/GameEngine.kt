package com.baothanhbin.game2d.game.logic

import com.baothanhbin.game2d.game.model.*
import com.baothanhbin.game2d.game.datastore.GameDataStore
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.launch

/**
 * Game Engine - quáº£n lÃ½ logic core cá»§a game
 */
class GameEngine(
    private val gameDataStore: GameDataStore? = null,
    private val coroutineScope: CoroutineScope? = null
) {
    
    private val _gameState = MutableStateFlow(GameState())
    val gameState: StateFlow<GameState> = _gameState.asStateFlow()
    private val economySystem = EconomySystem()
    private val mergeSystem = MergeSystem()
    private val combatSystem = CombatSystem()
    private val spawnSystem = SpawnSystem()
    private val effectSystem = EffectSystem()

    /**
     * Khá»Ÿi táº¡o game (khÃ´ng cÃ²n cháº¿ Ä‘á»™ khÃ³)
     */
    fun initGame(mode: GameMode = GameMode.CAMPAIGN) {
        val newState = GameState(gameMode = mode).startGame()
        _gameState.value = newState
    }
    
    
    /**
     * Cáº­p nháº­t game state
     */
    fun updateGameState(newState: GameState) {
        _gameState.value = newState
    }
    
    /**
     * Xá»­ lÃ½ pha prep
     */
    fun handlePrepPhase(state: GameState, deltaTimeMs: Long): GameState {
        // Trong pha prep, cáº§n update cooldowns cá»§a units Ä‘á»ƒ regen mana
        return combatSystem.updateUnitCooldowns(state, deltaTimeMs)
    }
    
    /**
     * Xá»­ lÃ½ pha combat
     */
    fun CombatLoop(state: GameState, deltaTimeMs: Long): GameState {
        var newState = state
        
        // Debug: Log combat phase info

        // Spawn enemies náº¿u chÆ°a Ä‘á»§ sá»‘ lÆ°á»£ng
        if (newState.remainingEnemiesToSpawn > 0) {
            newState = spawnSystem.spawnEnemies(newState, deltaTimeMs)
        }
        
        // Update units cooldowns
        newState = combatSystem.updateUnitCooldowns(newState, deltaTimeMs)
        
        // Units shoot at enemies
        newState = combatSystem.unitsShoot(newState)
        
        // Move bullets
        newState = combatSystem.moveBullets(newState, deltaTimeMs)
        
        // Move enemies
        newState = combatSystem.moveEnemies(newState, deltaTimeMs)
        
        // Handle collisions
        newState = combatSystem.handleCollisions(newState)
        
        // Update effects
        newState = effectSystem.updateEffects(newState, deltaTimeMs)
        
        // Clean up dead enemies and off-screen bullets
        newState = combatSystem.cleanup(newState)
        
        // Clean up finished effects
        newState = effectSystem.cleanupEffects(newState)
        
        // Check if enemies reached bottom
        newState = combatSystem.checkEnemiesReachedBottom(newState)

        // Má»™c: há»“i HP theo sao náº¿u cÃ³ Ã­t nháº¥t má»™t tÆ°á»›ng Má»™c trÃªn board
        val flowerUnits = newState.player.board.values.filter { it?.type == com.baothanhbin.game2d.game.model.HeroType.FLOWER }
        println("ðŸŒ¸ FLOWER DEBUG: flowerUnits count = ${flowerUnits.size}, current lives = ${newState.player.lives}")
        
        // Debug: Show all units on board
        newState.player.board.values.forEach { unit ->
            if (unit != null) {
                println("ðŸŒ¸ BOARD DEBUG: Unit type = ${unit.type}, star = ${unit.star}")
            }
        }
        
        if (flowerUnits.isNotEmpty()) {
            // Láº¥y tÆ°á»›ng Má»™c cÃ³ sao cao nháº¥t Ä‘á»ƒ xÃ¡c Ä‘á»‹nh hiá»‡u á»©ng
            val highestStarFlower = flowerUnits.maxByOrNull { it?.star ?: Star.ONE }!!
            
            val healPerSecond = when (highestStarFlower.star) {
                Star.ONE -> 2      // â˜…â˜†â˜† 2 HP má»—i giÃ¢y (1% cá»§a 200 HP/giÃ¢y)
                Star.TWO -> 4      // â˜…â˜…â˜† 4 HP má»—i giÃ¢y (2% cá»§a 200 HP/giÃ¢y)
                Star.THREE -> 10   // â˜…â˜…â˜… 10 HP má»—i giÃ¢y (5% cá»§a 200 HP/giÃ¢y)
            }
            
            val healPerMs = healPerSecond / 1000.0f // HP per millisecond
            val healAccumulatorFloat = newState.mocRegenAccumMs + (healPerMs * deltaTimeMs).toFloat()
            
            println("ðŸŒ¸ HEAL DEBUG: healPerSecond = $healPerSecond, healPerMs = $healPerMs, deltaTimeMs = $deltaTimeMs, healAccumulatorFloat = $healAccumulatorFloat, currentAccum = ${newState.mocRegenAccumMs}")
            
            if (healAccumulatorFloat >= 1.0) { // 1 HP worth of healing
                val healAmount = healAccumulatorFloat.toInt()
                val remainingAccumulator = healAccumulatorFloat - healAmount
                
                val healedPlayer = newState.player.copy(lives = (newState.player.lives + healAmount).coerceAtMost(200))
                newState = newState.copy(
                    player = healedPlayer,
                    mocRegenAccumMs = remainingAccumulator
                )
                
                println("ðŸŒ¸ FLOWER HEAL: +${healAmount} HP (${highestStarFlower.star} star, $healPerSecond HP/s)")
            } else {
                newState = newState.copy(mocRegenAccumMs = healAccumulatorFloat)
            }
        } else if (newState.mocRegenAccumMs != 0f) {
            newState = newState.copy(mocRegenAccumMs = 0f)
        }

        return newState
    }
    
    /**
     * Mua unit tá»« shop
     */
    fun buyUnit(slotIndex: Int) {
        val currentState = _gameState.value
        
        if (!currentState.canBuyUnit(slotIndex)) return
        
        val (newShop, unit) = currentState.shop.buyFromSlot(slotIndex)
        unit ?: return
        
        val newPlayer = currentState.player
            .copy(gold = currentState.player.gold - 1) // Fixed cost
            .addToBench(unit) ?: return
        
        // Auto-merge after buying
        val mergedPlayer = mergeSystem.tryAutoMerge(newPlayer)

        _gameState.value = currentState.copy(
            player = mergedPlayer,
            shop = newShop
        )
    }
    
    /**
     * BÃ¡n unit
     */
    fun sellUnit(unitId: String) {
        val currentState = _gameState.value
        
        // CÃ³ thá»ƒ bÃ¡n unit trong cáº£ PREP vÃ  COMBAT phase
        if (!currentState.canManageUnits()) return
        
        val unit = currentState.player.bench.find { it.id == unitId } ?: return
        
        val newPlayer = currentState.player
            .removeFromBench(unitId)
            .copy(gold = currentState.player.gold + unit.sellPrice)
        
        _gameState.value = currentState.copy(player = newPlayer)
    }
    
    /**
     * Reroll shop
     */
    fun rerollShop() {
        val currentState = _gameState.value
        
        if (!currentState.canReroll()) return
        
        val player = currentState.player
        val newShop = currentState.shop.reroll(player.level)
        
        val (newGold, newFreeRerolls) = if (player.freeRerollsRemaining > 0) {
            Pair(player.gold, player.freeRerollsRemaining - 1)
        } else {
            Pair(player.gold - Player.REROLL_COST, player.freeRerollsRemaining)
        }
        
        _gameState.value = currentState.copy(
            shop = newShop,
            player = player.copy(
                gold = newGold,
                freeRerollsRemaining = newFreeRerolls
            )
        )
    }
    
    /**
     * Mua XP
     */
    fun buyXP() {
        val currentState = _gameState.value
        
        if (!currentState.canBuyXP()) return
        
        val newPlayer = economySystem.buyXP(currentState.player)
        
        _gameState.value = currentState.copy(player = newPlayer)
    }
    
    /**
     * Deploy unit lÃªn board
     */
    fun deployUnit(unitId: String, slot: BoardSlot) {
        val currentState = _gameState.value
        
        if (!currentState.canManageUnits()) return
        
        val newPlayer = currentState.player.deployToBoard(unitId, slot) ?: return
        val mergedPlayer = mergeSystem.tryAutoMerge(newPlayer)
        
        _gameState.value = currentState.copy(player = mergedPlayer)
    }
    
    /**
     * Recall unit tá»« board
     */
    fun recallUnit(slot: BoardSlot) {
        val currentState = _gameState.value
        
        if (!currentState.canManageUnits()) return
        
        val newPlayer = currentState.player.recallFromBoard(slot) ?: return
        
        _gameState.value = currentState.copy(player = newPlayer)
    }
    
    /**
     * Swap unit giá»¯a bench vÃ  board
     */
    fun swapUnit(unitId: String, slot: BoardSlot) {
        val currentState = _gameState.value
        
        if (!currentState.canManageUnits()) return
        
        val newPlayer = currentState.player.swapBenchBoard(unitId, slot) ?: return
        val mergedPlayer = mergeSystem.tryAutoMerge(newPlayer)
        
        _gameState.value = currentState.copy(player = mergedPlayer)
    }
    
    /**
     * Toggle pause
     */
    fun togglePause() {
        _gameState.value = _gameState.value.togglePause()
    }
    
    /**
     * Restart game
     */
    fun restartGame() {
        initGame()
    }
    
    /**
     * Báº¯t Ä‘áº§u vÃ²ng chiáº¿n Ä‘áº¥u
     */
    fun startCombat() {
        val currentState = _gameState.value
        android.util.Log.d("GameEngine", "ðŸŽ¯ START COMBAT: Current phase=${currentState.roundPhase}, isInPrep=${currentState.isInPrep}")
        
        if (currentState.isInPrep) {
            val newState = currentState.startCombat()
            android.util.Log.d("GameEngine", "ðŸŽ¯ COMBAT STARTED: New phase=${newState.roundPhase}, lastSpawnTimeMs=${newState.lastSpawnTimeMs}, remainingEnemies=${newState.remainingEnemiesToSpawn}")
            _gameState.value = newState
        } else {
            android.util.Log.d("GameEngine", "ðŸŽ¯ CANNOT START COMBAT: Not in prep phase")
        }
    }
    
    /**
     * Force chuyá»ƒn sang combat phase (for testing)
     */
    fun forceCombatPhase() {
        val currentState = _gameState.value
        android.util.Log.d("GameEngine", "ðŸš€ FORCE COMBAT: Current phase=${currentState.roundPhase}")
        
        // Force start combat
        _gameState.value = currentState.startCombat()
        
        // Debug: Log after force combat
        val newState = _gameState.value
        android.util.Log.d("GameEngine", "ðŸš€ FORCE COMBAT DONE: New phase=${newState.roundPhase}, unitsOnBoard=${newState.player.board.values.count { it != null }}")
    }
    
    /**
     * LÆ°u dá»¯ liá»‡u khi game over
     */
    fun saveGameOverData(state: GameState) {
        gameDataStore?.let { dataStore ->
            coroutineScope?.launch {
                dataStore.saveBestScore(state.player.score, state.player.day)
                dataStore.saveGameStats(
                    day = state.player.day,
                    goldEarned = state.player.gold.toLong(),
                    enemiesKilled = 0L // TODO: track enemies killed
                )
            }
        }
    }
    
    /**
     * Clear processed sound events
     */
    fun clearSoundEvents() {
        val currentState = _gameState.value
        _gameState.value = currentState.clearSoundEvents()
    }
}
